# AMQP Shovel MTLS  with SNI = hostname - RFC-6125

https://www.rabbitmq.com/shovel.html
* Shovel plugin

https://datatracker.ietf.org/doc/html/rfc6125
* Representation and Verification of Domain-Based Application Service
Identity within Internet Public Key Infrastructure Using X.509 (PKIX)
Certificates in the Context of Transport Layer Security (TLS)
* RFC-6125

## Server Identity Check RFC-6125

### 2.4.  Server Identity Check

   During the TLS negotiation, the client MUST check its understanding
   of the server hostname against the server's identity as presented in
   the server Certificate message, in order to prevent man-in-the-middle
   attacks.  Matching is performed according to these rules:

   * The client MUST use the server hostname it used to open the
      connection as the value to compare against the server name as
      expressed in the server certificate.  The client MUST NOT use any
      form of the server hostname derived from an insecure remote source
      (e.g., insecure DNS lookup).  CNAME canonicalization is not done.

   *  If a subjectAltName extension of type dNSName is present in the
      certificate, it SHOULD be used as the source of the server's
      identity.

   *  Matching is case-insensitive.

   *  A "*" wildcard character MAY be used as the left-most name
      component in the certificate.  For example, *.example.com would
      match a.example.com, foo.example.com, etc. but would not match
      example.com.

   *  If the certificate contains multiple names (e.g. more than one
      dNSName field), then a match with any one of the fields is
      considered acceptable.



## Shovel
* A shovel behaves like a well-written client application, which connects to its source and destination, 
  consumes and republishes messages, and uses acknowledgements on both ends to cope with failures.
* A Shovel uses Erlang AMQP 0-9-1 and Erlang AMQP 1.0 clients under the hood.

## Scenario and roles for this test:
* VM2 Server:
* Getting shovel data
* VM1 Client
* Initiator of shovel amqp client for PUT or GET data
* Uses amqp_client

## Dependencies
It depends in which way you install RabbitMQ. 
The file usually is not present. If you need it, you have to create it.
* Prior to 3.7.0:
* %APPDATA%\RabbitMQ\rabbitmq.config
The configuration file is named rabbitmq.config and uses the Erlang term format (aka the "classic format" for RabbitMQ config files).
* RabbitMQ 3.7.0+
* %APPDATA%\RabbitMQ\rabbitmq.conf
In RabbitMQ 3.7.0+, the main configuration file is rabbitmq.conf. An additional config file named advanced.config is also used for some advanced configuration settings; it uses the classic format.

## Installing
For this test:
https://www.rabbitmq.com/install-windows.html
* rabbitmq-server-3.9.12
* otp_win64_24.2
* Win64 OpenSSL v1.1.1m

https://slproweb.com/products/Win32OpenSSL.html

* The Win32/Win64 OpenSSL Installation Project is dedicated to providing a simple installation of OpenSSL for Microsoft Windows. 
* Win64 OpenSSL v1.1.1m MSI (63MB Installer)

Latest News, https://www.openssl.org/

* 14-Dec-2021OpenSSL 1.1.1m is now available, including bug fixes
* For this you need OpenSSL 1.1.1 or lower (v 3 has an issue with -legacy and more, maybe fixed in the future)

## Environment
Azure

[![Screenshot](https://github.com/spawnmarvel/quickguides/blob/main/amqp/2_images_readme/azure_vm.jpg)




### TCP 5671 configuration (test shovel communication):

* 1 Install Erlang (admin)
* Set home after
```cmd
# Path to bin, set this after
ERLANG_HOME=C:\Program Files\erl-24.2
```

* 2 Set RabbitMQ environments

https://www.rabbitmq.com/configure.html

* In the context of deployment automation this means that environment variables such as 
* RABBITMQ_BASE and RABBITMQ_CONFIG_FILE should ideally be set before RabbitMQ is installed. 
* This would help avoid unnecessary confusion and Windows service re-installations.

```cmd
# Set this before install, preferable to to data disk, i.e F:
RABBITMQ_BASE=c:\software
RABBITMQ_CONFIG_FILE=c:\software\rabbitmq.conf
RABBITMQ_ADVANCED_CONFIG_FILE=c:\software\advanced.config
```


* 3 Install RabbitMQ (admin)
* 3.1 Rememeber the cookie, if there is an issue.
* 4 Enable management, shovel and shovel management
* 5 Add a new user on both VM's with access to vhost as administrator.
* 6 VM1 -> Oubound 5671, VM2 -> Inbound 5671
* 7 Make a test shovel with tcp listner 5671 (5672 must also avaliable on hosts VM1, VM2 but just in trusted network for writing data to RabbtiMQ, not internet)
* 8 Make the queues on VM1, if the shovel is running then 8
* 9 On VM2 queues should now be autogenerated
* 10 Check shovel VM1-> VM2 status running

## We now have a server and a client running a shovel to the server, TCP 5671 Success

### SSL VM2 Server:
* 1 Make CSR key must be exportable and CN + SAN must be hostname(.domain.something)
* 1.1 The certreq command can be used [...] create a new request from an .inf file
* https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certreq_1

```cmd
# [...]
CN = hostname(.domain.something)
# [...]
Exportable = TRUE
[RequestAttributes] 
SAN="dns=hostname(.domain.something)"
```
* 2 When CSR approved is back, import certificate in personal
* 3 Export personal as pfx (yes, export private key, include all certs if possible), save the password for later use
* 4 Get the private key

* 4.1 Run cms as admin navigate to openssl bin and check version
```cmd
cd "c:\Program Files\OpenSSL-Win64\bin"
openssl version
```
* It should be OpenSSL 1.1.1m 14 Dec 2021

* 4.2 Run the following command to extract the private key:
```cmd
openssl pkcs12 -in myfile.pfx -nocerts -out private.key.pem -nodes
```
* 4.3 Run the following command to extract the certificate
```cmd
openssl pkcs12 -in myfile.pfx -clcerts -nokeys -out public.crt.pem -nodes
```
* 4.4 Run the following command to verify CN (must be hostname(.domain.something))
```cmd
openssl x509 -nout -subject -in public.crt.pem
```
### 5 Update config VM2 Server:
* ssl listner 5671, ssl options cacertfile (use root.csr), certfile, keyfile, verify,verify_peer, password, set this {fail_if_no_peer_cert, false}]} ,\\ for win path
* Check shovel VM1-> VM2 status running
* SSL/TLS success
* Now the client knows that the server is THE SERVER
* Keep the VM1 (Client) test shovel as is with tcp listner 5671 for now

## We now have a server with certificate and a client with no certificate running a shovel to the server

### 6 Before we can configure mTLS (Client and Server): We need to have both CRS's approved for verify_peer:
* https://www.rabbitmq.com/ssl.html
* TLS has two primary purposes: encrypting connection traffic and providing a way to authenticate (verify) the peer to mitigate against Man-in-the-Middle attacks. 
* Both are  accomplished using a set of roles, policies and procedures known as Public Key Infrastructure (PKI).

### 7 Make Bundle of Root CA in this order:
* https://www.rabbitmq.com/ssl.html
* All trusted CA certificates must be added to a single file called the CA certificate bundle (MMC Gui of certmgr from our CSR)
* On Windows trusted certificates are managed using tools such as certmgr.
* For Rabbitmq to read the files:

* https://support.comodo.com/index.php?/Knowledgebase/Article/View/1145/1/how-do-i-make-my-own-bundle-file-from-crt-files

Open the .crt in Notepad and copy contents of all files in reverse order and paste them into the new file.

Example: (Intermediate 3, Intermediate 2,) Intermediate 1, Root Certificate.

* (VM1 intermediate,) VM1 root, (VM2 intermediate,) VM2 root on VM1, Save newly created file as 'vm1yourDomain.ca-bundle'.
* (VM2 intermediate,) VM2 root, (VM1 intermediate,) VM1 root on VM2, Save newly created file as 'vm2yourDomain.ca-bundle'.


### SSL VM1 Client:
* 1 = Same steps as VM2 but with VM1 hostname
* 2, 3, 4 = same steps
* GOTO 6, 7

### 8 Update config VM1 Client:
* 8.0 Add section {amqp_client, above the {rabbitmq_shovel, section
* 8.1 Now use the vm1yourDomain.ca-bundle as ssl_options, [{cacertfile, "c:\\op\ssl\\vm1yourDomain.ca-bundle"},
* 8.2 The rest of the ssl_options is what we have for VM1, ssl options certfile, keyfile, verify  verify_peer, password, set this {fail_if_no_peer_cert, true}]} ,\\ for win path
* 8.2 Here we will also add, {server_name_indication,"hostname-VM2"} so we only connect to that host (mTLS) and reject all other hosts.

### 8 Update config VM2 server: 
* Edit config to use the bundle: Now use the vm2yourDomain.ca-bundle as ssl_options, [{cacertfile, "c:\\op\ssl\\vm2yourDomain.ca-bundle"},
* 8.4 Check shovel VM1-> VM2 status running
* SSL/mTLS success

### 9 Update config VM2 server
* this {fail_if_no_peer_cert, false}]} to true
* SSL/mTLS success

Now the client knows that the server is THE SERVER and the server knows that the client is A CLIENT with it's own certificate and public / private keys for encryption.

Hence we can connect many clients to that server and all will be on mTls with encryption.

## We now have a server with certificate and a client with certificate and SNI enabled, running a shovel to the server. SSL/mTLS
## Erlang SNI

https://www.erlang.org/doc/man/ssl.html

* Specify the hostname to be used in TLS Server Name Indication extension. If not specified it will default to the Host argument of connect/[3,4] unless it is of type inet:ipaddress().

* The HostName will also be used in the hostname verification of the peer certificate using public_key:pkix_verify_hostname/2.


[![Screenshot](https://github.com/spawnmarvel/quickguides/blob/main/amqp/2_images_readme/azure_vm_rfc-6125.jpg)


https://www.ibm.com/support/pages/example-rabbitmq-configuration-file-encryption
